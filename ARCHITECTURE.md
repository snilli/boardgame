# Sudoku App - Code Flow & Architecture

## üöÄ Entry Point & Initialization

```typescript
// Next.js App Router Flow
layout.tsx ‚Üí page.tsx ‚Üí <SudokuApp />
```

## üèóÔ∏è Component Hierarchy & Call Stack

### Level 1: Root Component
```typescript
// SudokuApp.tsx (line 24)
export default function SudokuApp() {
  // Hooks initialization
  const { startGame, selectDifficulty, ... } = useGameActions()  // ‚Üê‚îÄ‚îÄ Main orchestrator
  const { highlightedNumber, handleCellSelection } = useUIStore() // ‚Üê‚îÄ‚îÄ UI state
  const { formattedTime } = useGameTimer()                       // ‚Üê‚îÄ‚îÄ Timer hook
  
  // Conditional rendering based on gameMode
  if (gameMode === 'start') return <GameStartScreen />
  if (gameMode === 'difficulty-select') return <DifficultyScreen />
  // ... main game UI
}
```

### Level 2: Action Orchestrator
```typescript
// useGameActions.ts (line 6)
export function useGameActions() {
  const gameFlowService = useMemo(() => new GameFlowServiceImpl(), [])  // ‚Üê‚îÄ‚îÄ Service layer
  
  // Store connections
  const { gameState, createNewGame, handleCellInput, ... } = useGameStore()  // ‚Üê‚îÄ‚îÄ Game state
  const { selectedCell, clearSelection } = useUIStore()                     // ‚Üê‚îÄ‚îÄ UI state
  
  // Action handlers
  const startGame = useCallback(() => setGameMode('difficulty-select'), [])
  const selectDifficulty = useCallback((difficulty: string) => {
    createNewGame(difficulty)  // ‚Üê‚îÄ‚îÄ Triggers game creation
    setGameMode('playing')
  }, [])
  
  const placeNumber = useCallback((value: number) => {
    if (!gameFlowService.canPlaceNumber(gameState, row, col)) return  // ‚Üê‚îÄ‚îÄ Business validation
    handleCellInput(row, col, value)  // ‚Üê‚îÄ‚îÄ Store mutation
  }, [])
}
```

### Level 3: State Management (Zustand Stores)

#### Game Store (gameStore.ts)
```typescript
export const useGameStore = create<GameState>()(
  devtools(persist(immer((set, get) => ({
    // State
    gameState: null,
    gameMode: 'start',
    history: [],
    
    // Key actions
    createNewGame: (difficulty: string) => {
      set((state) => {
        state.gameState = createInitialGameState(difficulty)  // ‚Üê‚îÄ‚îÄ Domain logic call
        state.gameMode = 'playing'
        state.history = []
      })
    },
    
    handleCellInput: (row, col, value) => {
      get().saveToHistory()  // ‚Üê‚îÄ‚îÄ Save state before changes
      set((state) => {
        if (state.gameState.noteMode) {
          // Note mode logic (lines 71-93)
          const cellKey = `${row}-${col}`
          if (!state.gameState.notes[cellKey]) {
            state.gameState.notes[cellKey] = []
          }
          // Toggle note logic...
        } else {
          // Number placement logic (lines 95-166)
          state.gameState.board[row][col] = value
          delete state.gameState.errors[cellKey]
          delete state.gameState.notes[cellKey]
          
          // Clear related notes in same row/col/box
          // Error validation
          // Completion check
        }
      })
    }
  })))
)
```

#### UI Store (uiStore.ts)
```typescript
export const useUIStore = create<UIState>()(
  immer((set) => ({
    selectedCell: null,
    highlightedNumber: null,
    
    handleCellSelection: (row, col, currentValue) => {
      set((state) => {
        // Toggle selection logic (lines 60-71)
        if (state.selectedCell?.row === row && state.selectedCell?.col === col) {
          state.selectedCell = null              // Deselect current
          state.highlightedNumber = null
        } else {
          state.selectedCell = { row, col }      // Select new cell
          state.highlightedNumber = currentValue !== 0 ? currentValue : null
        }
      })
    }
  }))
)
```

### Level 4: Domain Layer
```typescript
// sudoku-game.ts (line 51)
export const createInitialGameState = (difficulty?: string | number): SudokuGameState => {
  const difficultyToUse = difficulty ?? 'easy'
  
  let puzzleConfig
  if (typeof difficultyToUse === 'string') {
    puzzleConfig = createRandomPuzzle(difficultyToUse)  // ‚Üê‚îÄ‚îÄ Factory pattern
  } else {
    const sudoku = new SudokuAdvanced(3, 3, undefined, undefined, seed)
    const puzzle = sudoku.solve().setDifficulty(difficultyToUse)
    // Custom difficulty logic...
  }
  
  return {
    board: puzzleConfig.board.map(row => [...row]),
    initialBoard: puzzleConfig.initialBoard.map(row => [...row]),
    solution: puzzleConfig.solution,
    isCompleted: false,
    difficulty: puzzleConfig.difficulty,
    startTime: Date.now(),
    // ... other state
  }
}
```

### Level 5: Service Layer
```typescript
// GameFlowService.ts (line 29)
export class GameFlowServiceImpl implements GameFlowService {
  canPlaceNumber(gameState: SudokuGameState, row: number, col: number): boolean {
    if (!this.isGameActive(gameState)) return false           // ‚Üê‚îÄ‚îÄ Game state check
    if (gameState.initialBoard[row][col] !== 0) return false  // ‚Üê‚îÄ‚îÄ Initial clue check
    return true
  }
  
  isGameActive(gameState: SudokuGameState): boolean {
    return !gameState.isPaused && !gameState.isCompleted     // ‚Üê‚îÄ‚îÄ Pure business logic
  }
  
  validateCellAction(gameState, row, col) {
    if (!this.canPerformAction(gameState)) {
      const reason = gameState.isPaused ? 'Game is paused' : 'Game is completed'
      return { canPlace: false, canClear: false, reason }
    }
    // ... validation logic
  }
}
```

## üìû Call Flow Examples

### User Clicks Cell
```
1. User clicks cell ‚Üí SudokuBoard.tsx ‚Üí onCellClick(row, col)
   ‚Üì
2. SudokuApp.tsx ‚Üí handleCellClick() ‚Üí handleCellSelection(row, col, cellValue)
   ‚Üì  
3. useUIStore ‚Üí handleCellSelection() [uiStore.ts:60]
   ‚Üì
4. Zustand immer ‚Üí set((state) => { state.selectedCell = { row, col } })
   ‚Üì
5. React re-renders ‚Üí SudokuBoard gets new selectedCell prop
   ‚Üì
6. Cell highlights visually
```

### Number Input
```
1. User presses number ‚Üí useKeyboardHandler ‚Üí onNumberInput(num)
   ‚Üì
2. useGameActions ‚Üí placeNumber(value) [useGameActions.ts:63]
   ‚Üì
3. GameFlowService ‚Üí canPlaceNumber() validation [GameFlowService.ts:34]
   ‚Üì
4. useGameStore ‚Üí handleCellInput(row, col, value) [gameStore.ts:58]
   ‚Üì
5. saveToHistory() ‚Üí Deep clone current state [gameStore.ts:252]
   ‚Üì
6. Zustand immer ‚Üí Complex game logic [gameStore.ts:66-167]
   ‚Üì
7. Check completion ‚Üí set isCompleted if solved [gameStore.ts:154]
```

### Game Flow Transitions
```
Start Screen ‚Üí Difficulty Screen ‚Üí Game Screen
     ‚Üì               ‚Üì                ‚Üì
startGame()    selectDifficulty()  pause()/newGame()
     ‚Üì               ‚Üì                ‚Üì
gameMode =    createNewGame() +     gameMode =
'difficulty-  gameMode =            'paused'/'difficulty-select'
select'       'playing'
```

## üß† Architecture Layers

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ UI Layer                                        ‚îÇ
‚îÇ SudokuApp, DifficultyScreen, GameStartScreen   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Hook Layer                                      ‚îÇ
‚îÇ useGameActions, useGameTimer, useKeyboardHandler‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Store Layer (Zustand)                          ‚îÇ
‚îÇ useGameStore, useUIStore                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Service Layer                                   ‚îÇ
‚îÇ GameFlowServiceImpl                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Domain Layer                                    ‚îÇ
‚îÇ sudoku-game.ts, sudoku-advanced.ts             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Pattern Layer                                   ‚îÇ
‚îÇ PuzzleFactory, DifficultyStrategy               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîë Key Design Principles

### Single Responsibility
- **useGameActions**: Action orchestration only
- **GameFlowService**: Business rule validation only  
- **gameStore**: Game state management only
- **uiStore**: UI state management only

### Dependency Injection
- Services injected via `useMemo(() => new GameFlowServiceImpl(), [])`
- Stores connected via Zustand hooks
- No tight coupling between layers

### Immutable State Updates
- **Immer middleware**: Enables mutation-like syntax with immutable updates
- **History management**: Deep cloning for undo functionality
- **React Compiler**: Optimizes re-renders automatically

### Type Safety
```typescript
interface SudokuGameState {
  board: number[][]
  initialBoard: number[][]
  solution: number[][]
  isCompleted: boolean
  // ... all properties typed
}

type GameMode = 'start' | 'difficulty-select' | 'playing' | 'completed' | 'paused'
```

### Clean Architecture Benefits
1. **Testability**: Each layer can be tested in isolation
2. **Maintainability**: Clear separation of concerns
3. **Scalability**: Easy to add new features
4. **Performance**: React Compiler + Zustand optimization

## üìÅ File Structure & Responsibilities

```
src/
‚îú‚îÄ‚îÄ app/                     # Next.js App Router
‚îÇ   ‚îú‚îÄ‚îÄ layout.tsx          # Root layout
‚îÇ   ‚îî‚îÄ‚îÄ page.tsx            # Entry point ‚Üí <SudokuApp />
‚îú‚îÄ‚îÄ components/             # UI Components
‚îÇ   ‚îú‚îÄ‚îÄ SudokuApp.tsx       # Main orchestrator
‚îÇ   ‚îú‚îÄ‚îÄ SudokuBoard.tsx     # Game board rendering
‚îÇ   ‚îú‚îÄ‚îÄ DifficultyScreen.tsx # Difficulty selection
‚îÇ   ‚îî‚îÄ‚îÄ GameStartScreen.tsx # Welcome screen
‚îú‚îÄ‚îÄ hooks/                  # Custom Hooks
‚îÇ   ‚îú‚îÄ‚îÄ useGameActions.ts   # Action orchestration
‚îÇ   ‚îú‚îÄ‚îÄ useGameTimer.ts     # Timer management
‚îÇ   ‚îî‚îÄ‚îÄ useKeyboardHandler.ts # Keyboard input
‚îú‚îÄ‚îÄ stores/                 # Zustand Stores
‚îÇ   ‚îú‚îÄ‚îÄ gameStore.ts        # Game state & logic
‚îÇ   ‚îî‚îÄ‚îÄ uiStore.ts          # UI state management
‚îú‚îÄ‚îÄ services/               # Business Services
‚îÇ   ‚îî‚îÄ‚îÄ GameFlowService.ts  # Business rules validation
‚îú‚îÄ‚îÄ domain/                 # Domain Logic
‚îÇ   ‚îú‚îÄ‚îÄ sudoku-game.ts      # Core game logic
‚îÇ   ‚îî‚îÄ‚îÄ sudoku-advanced.ts  # Advanced puzzle generation
‚îî‚îÄ‚îÄ patterns/               # Design Patterns
    ‚îú‚îÄ‚îÄ PuzzleFactory.ts    # Factory pattern
    ‚îî‚îÄ‚îÄ DifficultyStrategy.ts # Strategy pattern
```

## üéØ Performance Optimizations

### React Compiler
- Automatic memoization of components and hooks
- Eliminates need for manual `React.memo`, `useMemo`, `useCallback`
- Zero-cost abstractions

### Zustand Optimizations
- **Granular subscriptions**: Components only re-render on relevant state changes
- **Immer middleware**: Efficient immutable updates
- **DevTools**: Development debugging without performance impact

### GPU Acceleration
```typescript
// Motion components with GPU acceleration
<motion.div 
  className="transform-gpu will-change-[transform,opacity]"
  animate={{ scale: [1, 1.1, 1] }}
/>
```

This architecture provides a solid foundation for complex state management while maintaining clean separation of concerns and optimal performance.